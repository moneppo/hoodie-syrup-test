/**
 * Hoodie plugin template
 * An example plugin worker, this is where you put your backend code (if any)
 */

var util = require('util');
var fs = require('fs');
var generator = require('./manifest-generator.js');

module.exports = function (hoodie, callback) {

	// Hack until I can get a path var from hoodie
	var path = __dirname + '/../../www/';

	var gen = generator(path, path + 'package.manifest');

	var updated = function(manifestText) {
	
		hoodie.config.set('manifest', manifestText);
		hoodie.config.set('lastUpdated', (new Date()).toString());

		hoodie.task.emit('syrup:updated');
	}

	var error = function(err) {
		console.log("Error: " + err);
	}

	var update = function(originDb, message) {
		gen.generate(updated, error);
	}

	hoodie.task.on('syrup:update', update);

	gen.generate(updated, {}, error);

	gen.startWatching(updated, {}, error);

  // plugin initialization complete
  callback();
};
